-- A. Digital Analysis
-- 1. How many users are there?

SELECT COUNT(DISTINCT user_id) FROM clique_bait.users AS user_count;

-- 2. How many cookies does each user have on average?

SELECT AVG(cookie_count) AS avg_cookie_count FROM
(
SELECT user_id, COUNT(cookie_id) as cookie_count
FROM clique_bait.users
GROUP BY user_id
) AS cookie_data;

-- 3. What is the unique number of visits by all users per month?

SELECT COUNT(DISTINCT visit_id) AS unique_visits, strftime('%m', event_time) AS month
FROM events
GROUP BY strftime('%m', event_time);

-- 4. What is the number of events for each event type?

SELECT id.event_name, COUNT(events.event_type) AS event_count
FROM clique_bait.events events
JOIN clique_bait.event_identifier id ON id.event_type=events.event_type
GROUP BY id.event_name;

-- 5. What is the percentage of visits which have a purchase event?
SELECT 100 * COUNT(DISTINCT e.visit_id) / (SELECT COUNT(DISTINCT visit_id) FROM clique_bait.events) AS purchase_percentage
FROM clique_bait.events e
WHERE event_type=3;

***--- 6. What is the percentage of visits which view the checkout page but do not have a purchase event?

--- 7. What are the top 3 pages by number of views?

SELECT events.page_id, hierarchy.page_name, COUNT(visit_id) AS visit_count
FROM events
JOIN page_hierarchy hierarchy ON events.page_id=hierarchy.page_id
GROUP BY hierarchy.page_name
ORDER BY COUNT(visit_id) DESC LIMIT 3;

-- 8. What is the number of views and cart adds for each product category?

SELECT hierarchy.product_category, COUNT(visit_id) AS visit_count,
    SUM(CASE WHEN id.event_type=2 THEN 1 ELSE 0 END) AS cart_adds
FROM events
JOIN page_hierarchy hierarchy ON events.page_id=hierarchy.page_id
JOIN event_identifier id ON id.event_type=events.event_type
WHERE hierarchy.product_category IS NOT NULL
GROUP BY hierarchy.product_category

***-- 9. What are the top 3 products by purchases?

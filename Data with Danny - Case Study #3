-- A. Customer Journey
-- 1. Based off the 8 sample customers provided in the sample from the subscriptions table, write a brief description about each customerâ€™s onboarding journey.
SELECT sub.*, p.plan_name, p.price from subscriptions sub
JOIN plans p ON p.plan_id=sub.plan_id
WHERE customer_id IN (1,2,11,13,15,16,18,19);


-- B. Data Analysis Questions
-- 1. How many customers has Foodie-Fi ever had?
SELECT COUNT(DISTINCT customer_id) FROM subscriptions;
ANSWER: 1000

***-- 2. 
-- 3. What plan start_date values occur after the year 2020 for our dataset? Show the breakdown by count of events for each plan_name.
SELECT sub.plan_id, p.plan_name, COUNT(p.plan_name) AS plan_sales
FROM subscriptions sub
JOIN plans p ON p.plan_id=sub.plan_id
WHERE sub.start_date>='2021-01-01'
GROUP BY p.plan_name
ORDER BY sub.plan_id;

***-- 4. What is the customer count and percentage of customers who have churned rounded to 1 decimal place?
DIVISION RETURNS 0--INCORRECT ANSWER, COME BACK AND FIX
SELECT total_customers, (customer_churn/total_customers) AS customer_churn_percentage
FROM (
SELECT COUNT(DISTINCT customer_id) AS total_customers,
    SUM(CASE WHEN plan_id=4 THEN 1
    END) AS customer_churn
FROM subscriptions
) AS churn_data

***-- 5. How many customers have churned straight after their initial free trial - what percentage is this rounded to the nearest whole number?
HAVE NOT CALCULATED PERCENTAGE
SELECT 
    SUM(CASE WHEN plan_name = 'churn' AND plan_rank = 2 THEN 1
    ELSE 0
    END) AS churn_post_trial
FROM
(
SELECT sub.customer_id, sub.plan_id, p.plan_name,
RANK() OVER (PARTITION BY customer_id ORDER BY sub.start_date) AS plan_rank
FROM subscriptions sub
JOIN plans p on p.plan_id=sub.plan_id
) AS plan_data

-- What is the number and percentage of customer plans after their initial free trial?
-- What is the customer count and percentage breakdown of all 5 plan_name values at 2020-12-31?
-- How many customers have upgraded to an annual plan in 2020?
-- How many customers downgraded from a pro monthly to a basic monthly plan in 2020?

-- D. Outside The Box Questions
-- 1. How would you calculate the rate of growth for Foodie-Fi?
-- 2. What key metrics would you recommend Foodie-Fi management to track over time to assess performance of their overall business?
-- 3. What are some key customer journeys or experiences that you would analyse further to improve customer retention?
-- 4. If the Foodie-Fi team were to create an exit survey shown to customers who wish to cancel their subscription, what questions would you include in the survey?
-- 5. What business levers could the Foodie-Fi team use to reduce the customer churn rate? How would you validate the effectiveness of your ideas?
